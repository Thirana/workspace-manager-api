You are working inside the repo “workspace-task-manager-api” (TypeScript, Express, Mongoose, ESM/NodeNext). Apply an “alignment patch” to switch from the current global RBAC model (role in JWT: user/admin) to the new authorization plan:

NEW PLAN (must implement now):
- Users have:
  - systemRole: "system_admin" | "user"   (global)
  - canCreateWorkspaces: boolean          (capability granted by system_admin)
- Workspace permissions will be handled later via workspace_memberships (owner/admin/member/viewer), so DO NOT encode workspace roles in JWT.
- Access token payload MUST include systemRole and validate iss/aud + restrict algorithms + enforce typ separation.
- Refresh tokens remain as-is (jti, typ=refresh) with rotation and DB persistence (hashed token stored).
- Express request auth context should be: req.auth = { userId, systemRole } (NOT role).

IMPORTANT STYLE / CONSTRAINTS:
- Keep changes minimal and safe.
- Preserve existing response envelopes and error handling.
- This project uses ESM; internal imports should use “.js” extension where applicable (consistent with existing files).
- Ensure TypeScript build passes.
- Update any route imports impacted by middleware rename.

TASKS (do in order):

1) Update User model to match new plan
File: src/models/user.model.ts
- Remove/stop using the old field: role: enum ['user','admin'].
- Add:
  - systemRole: { type: String, enum: ['system_admin','user'], default: 'user' }
  - canCreateWorkspaces: { type: Boolean, default: false }
- Keep existing best practices:
  - email: trim + lowercase + unique + index
  - password: select:false
  - timestamps:true
  - pre('save') hashing only when password modified (keep current mongoose v9-compatible async hook signature)
  - toJSON plugin still removes password and cleans _id/__v

2) Update token service to carry systemRole (NOT role)
File: src/services/token.service.ts
- Define type: SystemRole = 'system_admin' | 'user'
- Access token payload becomes: { sub: string; systemRole: SystemRole; typ: 'access' }
- Refresh token payload stays: { sub: string; jti: string; typ: 'refresh' }
- signAccessToken(userId: string, systemRole: SystemRole): string
- signRefreshToken unchanged signature
- verifyAccessToken returns decoded AccessPayload and checks: typ === 'access', sub present, systemRole present
- verifyRefreshToken checks: typ === 'refresh', sub+jti present
- Enforce JWT hardening:
  - include issuer/audience when signing (env.JWT_ISSUER / env.JWT_AUDIENCE)
  - verify with algorithms restriction (HS256) + issuer + audience
- Keep hashToken() as sha256 for refresh token DB storage.
NOTE: env.JWT_ISSUER and env.JWT_AUDIENCE are already added/validated by the user.

3) Update requireAuth middleware to attach systemRole
File: src/middlewares/requireAuth.ts
- Parse Authorization header “Bearer <token>”
- verifyAccessToken(token)
- set req.auth = { userId: payload.sub, systemRole: payload.systemRole }
- Ensure imports use .js extension: token.service.js, AppError.js

4) Update Express request type augmentation
File: src/types/express.d.ts
- Update req.auth shape to:
  - userId: string
  - systemRole: 'system_admin' | 'user'

5) Replace old requireRole with requireSystemRole (rename + update imports)
Files:
- Rename: src/middlewares/requireRole.ts  ->  src/middlewares/requireSystemRole.ts
- Update implementation:
  - requireSystemRole(...allowed: Array<'system_admin' | 'user'>)
  - it checks req.auth.systemRole exists; if missing => 401
  - if not allowed => 403
- Update any imports/usages that referenced requireRole:
  - src/routes/v1/auth.routes.ts (and anywhere else)
  - If there is still an “admin-only test” route, keep it but update to requireSystemRole('system_admin')
- If there are no longer any usages, still keep the middleware file renamed to avoid confusion later.

6) Update AuthService to sign access tokens with systemRole
File: src/services/auth.service.ts
- In login():
  - call signAccessToken(user.id, user.systemRole)
- In refresh():
  - fetch user from DB (by tokenDoc.user or payload.sub) to get current systemRole
  - signAccessToken(user.id, user.systemRole)
- Keep refresh rotation + hashed token verification as-is.
- Keep RequestMeta typing style: meta?: { ip?: string | undefined; userAgent?: string | undefined }

7) Update any controllers/routes affected by req.auth change
Files likely:
- src/controllers/auth.controller.ts
- src/routes/v1/auth.routes.ts
- src/middlewares/requireAuth.ts already updated
- Any places referencing req.auth.role must be changed to req.auth.systemRole or removed if not needed.
- Ensure /me still works (it should only need userId).

8) Dev DB compatibility note (do NOT build a full migration system now)
- Add a short comment in code or a small note in README is optional.
- But ensure app doesn’t crash if existing user docs still have “role”. New code should rely on systemRole/canCreateWorkspaces going forward. For local testing, the user can manually update existing user documents in Mongo to add systemRole and canCreateWorkspaces, or re-register.

ACCEPTANCE CRITERIA:
- `npm run build` succeeds.
- Login -> returns accessToken; refresh works; logout works; /me works with Bearer access token.
- Any previous “admin-only” route check now uses systemRole (system_admin).
- No references remain to req.auth.role or User.role (unless explicitly left behind as a deprecated field, but prefer to remove it fully from schema).

After implementing, provide me a brief list of files changed and what was changed in each (bulleted), and confirm build result.
